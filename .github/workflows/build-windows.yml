name: Build Windows Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.3)'
        required: true
        type: string
      upload_artifact:
        description: 'Upload Windows build as artifact'
        required: false
        default: true
        type: boolean
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get version from tag or input
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            # Extract version from tag (remove 'v' prefix)
            $VERSION = "${{ github.ref_name }}" -replace "^v", ""
          }
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $VERSION"

      - name: Install dependencies
        run: |
          cd recognizing
          flutter pub get

      - name: Generate code
        run: |
          cd recognizing
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Build Windows Release
        run: |
          cd recognizing
          flutter build windows --release

      - name: Create distribution package
        run: |
          New-Item -ItemType Directory -Path "dist/windows" -Force
          Copy-Item -Path "recognizing\build\windows\x64\runner\Release\*" -Destination "dist\windows" -Recurse

          # Create NSIS installer script
          @"
          !define APPNAME "Recogniz.ing"
          !define VERSION "${{ steps.version.outputs.version }}"
          !define PUBLISHER "Recogniz.ing"
          !define DESCRIPTION "AI-powered voice typing application"
          !define URL "https://github.com/xicv/recogniz.ing"

          !include "MUI2.nsh"

          Name "${APPNAME}"
          OutFile "recognizing-${VERSION}-windows.exe"
          InstallDir "$PROGRAMFILES64\${APPNAME}"
          RequestExecutionLevel admin

          VIProductVersion "${VERSION}.0"
          VIAddVersionKey "ProductName" "${APPNAME}"
          VIAddVersionKey "CompanyName" "${PUBLISHER}"
          VIAddVersionKey "FileDescription" "${DESCRIPTION}"
          VIAddVersionKey "FileVersion" "${VERSION}"
          VIAddVersionKey "ProductVersion" "${VERSION}"
          VIAddVersionKey "LegalCopyright" "Â© ${PUBLISHER}"
          VIAddVersionKey "OriginalFilename" "recognizing-${VERSION}-windows.exe"

          ; Modern UI
          !define MUI_ABORTWARNING
          !define MUI_ICON "build\windows\runner\Release\resources\app_icon.ico"
          !define MUI_UNICON "build\windows\runner\Release\resources\app_icon.ico"

          ; Pages
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_LICENSE "LICENSE"
          !insertmacro MUI_PAGE_COMPONENTS
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_UNPAGE_WELCOME
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          !insertmacro MUI_UNPAGE_FINISH

          ; Languages
          !insertmacro MUI_LANGUAGE "English"

          ; Installer sections
          Section "Main Application" SEC01
              SetOutPath "$INSTDIR"
              File /r "*\*"
              CreateDirectory "$SMPROGRAMS\${APPNAME}"
              CreateShortCut "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "$INSTDIR\recognizing.exe"
              CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\recognizing.exe"
              WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
              WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "$INSTDIR\uninstall.exe"
              WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSION}"
              WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${PUBLISHER}"
              WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "URLInfoAbout" "${URL}"
              WriteUninstaller "$INSTDIR\uninstall.exe"
          SectionEnd

          ; Uninstaller section
          Section "Uninstall"
              Delete "$INSTDIR\uninstall.exe"
              Delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
              Delete "$DESKTOP\${APPNAME}.lnk"
              RMDir /r "$SMPROGRAMS\${APPNAME}"
              RMDir /r "$INSTDIR"
              DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"
          SectionEnd
          "@ | Out-File -FilePath "installer.nsi" -Encoding utf8

          Set-Location "dist\windows"

          # Try to create NSIS installer if makensis is available
          if (Get-Command makensis -ErrorAction SilentlyContinue) {
            Write-Host "Creating NSIS installer..."
            makensis ..\installer.nsi
            if (Test-Path "recognizing-${{ steps.version.outputs.version }}-windows.exe") {
              Write-Host "Successfully created Windows installer"
            } else {
              Write-Host "NSIS installer creation failed, falling back to ZIP"
              7z a -tzip "recognizing-${{ steps.version.outputs.version }}-windows.zip" *
            }
          } else {
            Write-Host "NSIS not found, creating ZIP package..."
            7z a -tzip "recognizing-${{ steps.version.outputs.version }}-windows.zip" *
          }

      - name: Upload build artifact
        if: github.event.inputs.upload_artifact == 'true' || github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: recognizing-windows-${{ steps.version.outputs.version }}
          path: |
            dist/windows/recognizing-${{ steps.version.outputs.version }}-windows.exe
            dist/windows/recognizing-${{ steps.version.outputs.version }}-windows.zip
          retention-days: 30

      - name: Download macOS build artifacts
        if: github.event_name == 'push'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: release.yml
          workflow_conclusion: success
          path: downloads

      - name: Create complete release package
        if: github.event_name == 'push'
        run: |
          # Create directories
          New-Item -ItemType Directory -Path "landing/public/downloads/${{ steps.version.outputs.version }}/windows" -Force
          New-Item -ItemType Directory -Path "landing/public/downloads/${{ steps.version.outputs.version }}/macos" -Force

          # Copy Windows build
          Copy-Item -Path "dist/windows/recognizing-${{ steps.version.outputs.version }}-windows.zip" -Destination "landing/public/downloads/${{ steps.version.outputs.version }}/windows/"

          # Copy macOS build if available
          if (Test-Path "downloads/recognizing-macos-${{ steps.version.outputs.version }}.zip") {
            Copy-Item -Path "downloads/recognizing-macos-${{ steps.version.outputs.version }}.zip" -Destination "landing/public/downloads/${{ steps.version.outputs.version }}/macos/recognizing-${{ steps.version.outputs.version }}-macos.zip"
          }

          # Generate manifest
          @"
          {
            "version": "${{ steps.version.outputs.version }}",
            "platforms": {
              "windows": "downloads/windows/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-windows.zip",
              "macos": "downloads/macos/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-macos.zip",
              "linux": "downloads/linux/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-linux.tar.gz",
              "android_apk": "downloads/android/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}.apk",
              "android_aab": "downloads/android/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}.aab",
              "web": "downloads/web/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-web.zip"
            },
            "build_date": "$(Get-Date -UFormat '%Y-%m-%dT%H:%M:%SZ')"
          }
          "@ | Out-File -FilePath landing/public/downloads/manifest.json -Encoding utf8

      - name: Update Downloads Page
        if: github.event_name == 'push'
        run: |
          # Create a simple index for the downloads
          @"
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Recogniz.ing Downloads</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
              .platform { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
              h1 { color: #333; }
              a { display: inline-block; padding: 10px 20px; background: #007AFF; color: white; text-decoration: none; border-radius: 5px; margin: 5px; }
              a:hover { background: #0056CC; }
            </style>
          </head>
          <body>
            <h1>Recogniz.ing v${{ steps.version.outputs.version }}</h1>
            <p>AI-powered voice typing application</p>

            <div class="platform">
              <h2>Windows</h2>
              <a href="downloads/windows/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-windows.zip">Download Windows ZIP</a>
            </div>

            <div class="platform">
              <h2>macOS</h2>
              <a href="downloads/macos/${{ steps.version.outputs.version }}/recognizing-${{ steps.version.outputs.version }}-macos.zip">Download macOS ZIP</a>
            </div>

            <p><small>Built on $(Get-Date -UFormat '%Y-%m-%d %H:%M:%S UTC')</small></p>
          </body>
          </html>
          "@ | Out-File -FilePath landing/public/downloads.html -Encoding utf8

      - name: Commit downloads to main
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add landing/public/downloads/
          git add landing/public/downloads.html
          git add landing/public/downloads/manifest.json
          git commit -m "build: Add v${{ steps.version.outputs.version }} downloads" || echo "No changes to commit"
          git push